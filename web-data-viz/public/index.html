<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gatices</title>
    <link
      rel="shortcut icon"
      href="./assets/images/favicon.png"
      type="image/x-icon"
    />
    <link rel="stylesheet" href="./css/reset.css" />
    <link rel="stylesheet" href="./css/styles.css" />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <link
      href="https://unpkg.com/nes.css/css/nes-core.min.css"
      rel="stylesheet"
    />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  </head>
  <body>
    <main>
      <header>
        <img class="logo" src="./assets/images/logo.png" alt="" />
        <nav>
          <ul>
            <a href="#inicio">
              <div>
                <li>Início</li>
              </div>
            </a>
            <a href="#sobre">
              <div>
                <li>Sobre</li>
              </div>
            </a>
            <a href="#curiosidades">
              <div>
                <li>Curiosidades</li>
              </div>
            </a>
            <a href="#crie-seu-gato">
              <div>
                <li>Crie seu gato</li>
              </div>
            </a>
            <a href="#fale-conosco">
              <div>
                <li>Fale conosco</li>
              </div>
            </a>
            <div class="links-login-cadastro" id="sessaoLogin">
              <a href="./login.html">
                <p>Entrar</p>
              </a>
              <span>|</span>
              <a href="./cadastro.html">
                <p>Criar conta</p>
              </a>
            </div>
            <div class="saudacao" id="saudacao">
              <h1>Miauu, <span id="b_usuario"></span>!</h1>
              <a onclick="sair()">
                <i class="fa-solid fa-arrow-right-from-bracket"></i>
              </a>
            </div>
          </ul>
        </nav>
      </header>

      <section class="parallax parallax-bg"></section>
      <section class="inicio" id="inicio">
        <img class="gatinho" src="./assets/images/gatinho-rosa.png" alt="" />
        <img class="gatinho2" src="./assets/images/gatinho-rosa.png" alt="" />
        <div class="conteudo-inicio">
          <h1>Seja bem-vindo à Gatices!</h1>
          <p>
            Aqui é o lugar perfeito para todos que amam o universo dos gatinhos!
            Prepare-se para explorar conteúdos repletos de fofura, dicas de
            cuidado, curiosidades e muita diversão sobre esses pequenos felinos.
            Quer você seja um tutor apaixonado ou apenas um admirador dos
            encantos felinos, sinta-se em casa e deixe-se levar pelas patinhas
            que vão guiá-lo em cada página. Entre, descubra e aproveite –
            afinal, gatos tornam a vida mais leve e feliz!
          </p>
        </div>
      </section>
      <section>
        <div class="sobre" id="sobre">
          <div class="conteudo-sobre">
            <h1>Sobre Nós</h1>
            <p>
              Bem-vindo ao nosso espaço dedicado aos adoráveis gatinhos! Aqui,
              acreditamos que esses pequenos felinos não são apenas pets, mas
              verdadeiros membros da família que trazem alegria e amor para
              nossas vidas.
            </p>
            <h2>Nossa Missão</h2>
            <p>
              Nossa missão é celebrar a beleza, a curiosidade e a personalidade
              única de cada gatinho. Oferecemos informações valiosas sobre
              cuidados, saúde e comportamento, além de dicas sobre como criar um
              ambiente acolhedor para seu amigo felino. Acreditamos que cada
              gatinho merece um lar cheio de carinho e atenção.
            </p>
          </div>
        </div>
      </section>
      <section class="curiosidades" id="curiosidades">
        <div class="conteudo-curiosidades">
          <h1>Curiosidades!!!</h1>
          <h2>Você sabia?</h2>
          <ul>
            <li>
              Os gatos domésticos desenvolveram uma forma única de se comunicar
              com os humanos. Enquanto os felinos na natureza costumam usar
              vocalizações para se comunicar com outros animais, os gatos
              domésticos frequentemente "falam" apenas com os humanos,
              utilizando uma variedade de miados, ronronados e expressões
              faciais.
            </li>
            <li>
              Os gatos têm um ciclo de sono muito interessante. Eles dormem
              entre 12 a 16 horas por dia, e cerca de 70% desse sono é leve,
              permitindo que eles fiquem alertas a qualquer movimento ou som,
              mesmo enquanto descansam.
            </li>
            <li>
              Os gatos têm uma visão noturna excepcional, permitindo que vejam
              em ambientes com apenas 1/6 da luz necessária para que um humano
              enxergue. Isso é devido à presença de uma estrutura chamada
              "tapetum lucidum" em seus olhos, que reflete a luz e melhora a
              visão em condições de pouca luz.
            </li>
            <li>
              Os bigodes dos gatos não são apenas para estética. Eles são órgãos
              sensoriais altamente sensíveis que ajudam os gatos a medir espaços
              e detectar mudanças em seu ambiente, permitindo que percebam
              objetos e até mesmo correntes de ar.
            </li>
          </ul>
        </div>
        <img src="./assets/images/gatinho-rosa2.png" alt="" />
      </section>
      <section class="crie-seu-gato" id="crie-seu-gato">
        <div class="conteudo-crie-seu-gato">
          <h1>Crie o seu gato virtual!</h1>
        </div>
        <div class="card-container">
          <div class="selecao" id="div_selecao">
            <h1>Selecione o tipo de gato</h1>
            <div class="selecao-gatos">
              <img
                src="./assets/gatinhos-selecao/rosa.gif"
                onclick="selecionarGato('rosa')"
                style="
                  height: 90px;
                  width: 90px;
                  transform: translateY(40px);
                  margin-right: 15px;
                "
                alt=""
              />
              <img
                src="./assets/gatinhos-selecao/calico2.gif"
                onclick="selecionarGato('calico')"
                style="
                  height: 80px;
                  width: 70px;
                  transform: translateY(35px);
                  margin-right: 15px;
                "
                alt=""
              />
              <img
                src="./assets/gatinhos-selecao/cinza.gif"
                onclick="selecionarGato('cinza')"
                alt=""
              />
              <img
                src="./assets/gatinhos-selecao/branco.gif"
                onclick="selecionarGato('branco')"
                alt=""
              />
              <img
                src="./assets/gatinhos-selecao/laranja.gif"
                onclick="selecionarGato('laranja')"
                alt=""
              />
              <img
                src="./assets/gatinhos-selecao/roxo.gif"
                onclick="selecionarGato('roxo')"
                alt=""
              />
              <img
                src="./assets/gatinhos-selecao/preto.gif"
                onclick="selecionarGato('preto')"
                alt=""
              />
            </div>
          </div>
          <div class="info-gato" id="div_info_gato">
            <a onclick="mostrarSelecao()">
              <i class="fas fa-arrow-left"></i>
            </a>
            <h1>Digite o nome do seu gato</h1>
            <div class="campos">
              <input type="text" id="ipt_nome_gato" />
              <ul class="generos">
                <li class="genero masculino">
                  <input
                    type="radio"
                    class="feminino"
                    name="genero"
                    id="masc"
                    onclick="selecionarGenero('M')"
                  />
                  <img
                    class="check"
                    src="assets/images/check-icon.png"
                    alt=""
                  />
                  <label for="masc">Masculino</label>
                </li>
                <li class="genero feminino">
                  <input
                    type="radio"
                    class="masculino"
                    name="genero"
                    id="fem"
                    onclick="selecionarGenero('F')"
                  />
                  <img
                    class="check"
                    src="assets/images/check-icon.png"
                    alt=""
                  />
                  <label for="fem" class="icone-fem">Feminino</label>
                </li>
              </ul>
              <button class="btn-criar" onclick="cadastrar()">Criar</button>
            </div>
          </div>
          <div class="gato" id="div_gato">
            <div class="container-celular">
              <span class="notificacao" id="notificacao" style="display: none;"></span>
              <a onclick="mostrarDashboard()" class="celular">
                <img src="./assets//images/celular.png" style="width: 70px; height: 70px" alt="">
              </a>
            </div>
            <div class="dashboard" id="dashboard" style="display: none;">
              <a class="btn-fechar" onclick="fecharDashboard()">
                <i class="fa-solid fa-circle-xmark"></i>
              </a>
              <h2>Monitoramento de Fome e Sede</h2>
              <div class="container-grafico">
                <div class="grafico" style="width: 50%; height: 400px;">
                  <canvas id="myChartCanvas" width="400" height="300"></canvas>
                </div>
                  <div class="kpis">
                    <div class="fomeKPI" id="fomeKPI">
                      <p>Fome atual:</p>
                      <div class="kpiFome"><span class="indicador_fome" id="indicador_fome"></span></div>
                    </div>
                    <div class="sedeKPI" id="sedeKPI">
                      <p>Sede atual:</p>
                      <div class="kpiSede"><span class="indicador_sede" id="indicador_sede"></span></div>
                    </div>
                </div>
              </div>
            </div>
            <div class="status">
              <p>Nome: <span id="nome_gato"></span></p>
              <p>Genero: <span id="genero_gato"></span></p>
              <p>Raça: <span id="raca_gato"></span></p>
              <p>
                Fome: <div class="fome"><span class="fome_gato" id="fome_gato"></span></div>
              </p>
              <p>Sede: <div class="sede"><span class="sede_gato" id="sede_gato"></span></div></p>
            </div>
            <div class="gif andar-direita" id="gif_gato"></div>
            <div class="botoes">
              <button onclick="darComida()">Dar comida</button>
              <button onclick="darAgua()">Dar água</button>
            </div>
          </div>
        </div>
      </section>
      <section class="fale-conosco" id="fale-conosco">
        <div class="conteudo-fale-conosco">
          <h1>Mande um miado</h1>
        </div>
        <div class="card-fale-conosco">
              <form class="campos" method="POST" action="https://getform.io/f/bwnnvzla" target="_blank">
              <p>Nome:</p>
              <input type="text" name="name" id="ipt_name"/><br />
              <p>Email:</p>
              <input type="email" name="email" id="ipt_email"/><br />
              <p>Mensagem:</p>
              <textarea name="message" id="ipt_message"></textarea><br />
              <button type="submit">Enviar</button>
            </form>
        </div>
        <img
          class="pixel-cat"
          src="./assets/images/pink-pixel-cat.png"
          alt=""
        />
        <img
          class="pixel-cat2"
          src="./assets/images/pink-pixel-cat.png"
          alt=""
        />
      </section>
      <footer>
        <div class="footer-container">
          <img src="./assets/images/logo.png" alt="" />
          <nav class="footer-nav">
            <ul>
              <a href="#inicio">
                <li>Início</li>
              </a>
              <span>|</span>
              <a href="#sobre">
                <li>Sobre</li>
              </a>
              <span>|</span>
              <a href="#curiosidades">
                <li>Curiosidades</li>
              </a>
              <span>|</span>
              <a href="#crie-seu-gato">
                <li>Crie seu gato</li>
              </a>
              <span>|</span>
              <a href="#fale-conosco">
                <li>Mande um miado</li>
              </a>
            </ul>
          </nav>
          <div class="social">
            <a href="" target="_blank">
              <i class="fa-brands fa-linkedin"></i>
            </a>
            <a href="https://instagram.com/nic.cs_" target="_blank">
              <i class="fa-brands fa-instagram"></i>
            </a>
            <a href="https://github.com/NiCoelho-tech" target="_blank">
              <i class="fa-brands fa-github"></i>
            </a>
          </div>
        </div>
        <p>© 2024 Gatices. Todos os direitos reservados.</p>
      </footer>
    </main>
    <script>
      ipt_name.value = "";
      ipt_email.value = "";
      ipt_message.value = "";

      b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

      const login = sessaoLogin;
      const saudacaoUsuario = saudacao;

      let lista_gatos_cadastrados = [];

      if (sessionStorage.EMAIL_USUARIO && sessionStorage.NOME_USUARIO && sessionStorage.ID_GATO != null) {
        login.style.display = "none";
        saudacaoUsuario.style.display = "flex";
      } else if (sessionStorage.EMAIL_USUARIO && sessionStorage.NOME_USUARIO) {
        login.style.display = "none";
        saudacaoUsuario.style.display = "flex";
        div_selecao.style.display = "flex";
      } else {
        login.style.display = "flex";
        saudacaoUsuario.style.display = "none";
        div_selecao.style.display = "flex";
      }

      function sair() {
        sessionStorage.clear();
        window.location.reload();
      }

      var generoGato = "";
      var racaGato = "";

      function selecionarGato(gato) {
        const selecao = div_selecao;
        const infoGato = div_info_gato;

        racaGato = gato;
        selecao.style.display = "none";
        infoGato.style.display = "flex";
      }

      function selecionarGenero(genero) {
        generoGato = genero;
      }

      function mostrarSelecao() {
        const selecao = div_selecao;
        const infoGato = div_info_gato;

        selecao.style.display = "flex";
        infoGato.style.display = "none";
      }

      function cadastrar() {
      if (sessionStorage.EMAIL_USUARIO && sessionStorage.NOME_USUARIO) {
    var nomeGatoVar = ipt_nome_gato.value;
    var generoVar = generoGato;
    var racaVar = racaGato;
    var donoVar = sessionStorage.ID_USUARIO;

    div_info_gato.style.display = "none";
    div_gato.style.display = "flex";

    for (let i = 0; i < lista_gatos_cadastrados.length; i++) {
      if (lista_gatos_cadastrados[i].nomeGato == nomeGatoVar) {
        alert("Esse gato já existe!");
        return false;
      }
    }

    fetch("/gatos/cadastrar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        nomeGatoServer: nomeGatoVar,
        generoServer: generoVar,
        racaServer: racaVar,
        donoServer: donoVar,
      }),
    })
      .then(function (resposta) {
        if (resposta.ok) {
          return resposta.json(); // Transformar a resposta em JSON
        } else {
          throw "Houve um erro ao tentar realizar o cadastro!";
        }
      })
      .then(function (dadosGato) {
        console.log("Gato cadastrado:", dadosGato);

        sessionStorage.ID_GATO = dadosGato.id;
        sessionStorage.NOME_GATO = dadosGato.nome;
        sessionStorage.RACA_GATO = dadosGato.raca;
        sessionStorage.GENERO_GATO = dadosGato.genero;

        lista_gatos_cadastrados.push(dadosGato);

         verificarGato()
      })
      .catch(function (erro) {
        console.log(`#ERRO: ${erro}`);
      });

    return false;
  } else {
    window.location = "/login.html";
  }
}


      async function verificarGato() {
        try {
          const resposta = await fetch("/gatos/autenticar", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              idDonoServer: sessionStorage.ID_USUARIO,
            }),
          });

          if (!resposta.ok) {
            throw new Error("Erro ao autenticar o gato!");
          }

          const json = await resposta.json();

          console.log(json);
          console.log(JSON.stringify(json));

          sessionStorage.ID_GATO = json.id;
          sessionStorage.NOME_GATO = json.nome;
          sessionStorage.GENERO_GATO = json.genero;
          sessionStorage.RACA_GATO = json.raca;

          if (sessionStorage.FOME_GATO == 0 || sessionStorage.SEDE_GATO == 0) {
            sessionStorage.STATUS_VIDA = "MORTO";
          }
          
          if (sessionStorage.STATUS_VIDA == "MORTO") {
          sessionStorage.removeItem("STATUS_VIDA");
                sessionStorage.removeItem("FOME_GATO");
                sessionStorage.removeItem("SEDE_GATO");
                sessionStorage.removeItem("DT_HORA");
                sessionStorage.removeItem("NOME_GATO");
                sessionStorage.removeItem("RACA_GATO");
                sessionStorage.removeItem("GENERO_GATO");
              
                // div_gato.style.display = "none";
        } else if (sessionStorage.EMAIL_USUARIO && sessionStorage.NOME_USUARIO && sessionStorage.ID_GATO != null) {
            const lista_racas = [
              "rosa",
              "calico",
              "cinza",
              "branco",
              "laranja",
              "roxo",
              "preto",
            ];

            const lista_cores = [
              "pink",
              "#CD7F32",
              "#848884",
              "#FFF8DC",
              "#F28C28",
              "#DA70D6",
              "#413839",
            ];

            let cor = 0;

            const nomeGato = sessionStorage.NOME_GATO;
            const generoGato = sessionStorage.GENERO_GATO;
            const racaGato = sessionStorage.RACA_GATO;

            div_selecao.style.display = "none";
            div_info_gato.style.display = "none";
            div_gato.style.display = "flex";

            nome_gato.textContent = nomeGato;
            genero_gato.textContent =
            generoGato === "M" ? "Masculino" : "Feminino";
            raca_gato.textContent = racaGato;

            for (let i = 0; i < lista_racas.length; i++) {
              if (racaGato === lista_racas[i]) {
                cor = lista_cores[i];
                break;
              }
            }

            div_gato.style.backgroundColor = cor;

            const cat = document.getElementById("gif_gato");

            let tipo = racaGato;

            function updateCatSprite(tipo, numero) {
              const spriteSheet = `./assets/sprite-sheets/sheet-${tipo}/${numero}.png`;
              cat.style.background = `url('${spriteSheet}') no-repeat`;
              cat.style.backgroundSize = "536px 124px"; 
            }

            const animations = [
              { className: "andar-direita", numero: 1, duration: 2000 }, 
              { className: "andar-direita-mais-um-pouco", numero: 1, duration: 2000 },
              { className: "andar-para-o-meio-esquerda", numero: 1, duration: 2000 },
              { className: "andar-para-o-meio-esquerda-mais-um-pouco", numero: 1, duration: 2000 },
              { className: "andar-esquerda", numero: 1, duration: 2000 },
              { className: "andar-esquerda-mais-um-pouco", numero: 1, duration: 2000 },
              { className: "andar-para-o-meio-direita", numero: 1, duration: 2000 },
              { className: "andar-para-o-meio-direita-mais-um-pouco", numero: 1, duration: 2000 },
              { className: "parar", numero: 2, duration: 2000 }, 
              { className: "lamber", numero: 3, duration: 2000 }, 
            ];

            function playSequence(element, animations) {
              let currentIndex = 0;

              function nextAnimation() {
                if (currentIndex >= animations.length) {
                  currentIndex = 0; 
                }

                const { className, numero, duration } = animations[currentIndex];

                updateCatSprite(tipo, numero);

                element.className = "gif";
                element.classList.add(className);

                setTimeout(() => {
                  currentIndex++;
                  nextAnimation();
                }, duration);
              }

              nextAnimation(); 
            }

            playSequence(cat, animations);
          }
          
        } catch (erro) {
          console.log(`Erro: ${erro.message}`);
        }
      }

      function listar() {
        fetch("/gatos/listar", {
          method: "GET",
        })
          .then(function (resposta) {
            resposta.json().then((gatos) => {
              gatos.forEach((gatos) => {
                lista_gatos_cadastrados.push(gatos);
              });
            });
          })
          .catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
          });
      }

      let fome = sessionStorage.FOME_GATO !== undefined ? parseInt(sessionStorage.FOME_GATO) : 100;
      let sede = sessionStorage.SEDE_GATO !== undefined ? parseInt(sessionStorage.SEDE_GATO) : 100;
      let intervaloStatus; // Identificador do intervalo

      // Função para iniciar o intervalo
      function iniciarIntervalo() {
        if (!intervaloStatus) { // Inicia o intervalo apenas uma vez
          intervaloStatus = setInterval(atualizarStatus, 10000);
        }
      }

      iniciarIntervalo();

      
      function darComida() {
        fome = Math.min(fome + 15, 100);
        sede = Math.max(sede - 3, 0);

        sessionStorage.FOME_GATO = fome;
        sessionStorage.SEDE_GATO = sede;

        console.log(sessionStorage.STATUS_VIDA, sessionStorage.DT_HORA)

        atualizarStatus()
      }

      function darAgua() {
        sede = Math.min(sede + 15, 100);
        fome = Math.max(fome - 3, 0);

        sessionStorage.FOME_GATO = fome;
        sessionStorage.SEDE_GATO = sede;

        console.log(sessionStorage.SEDE_GATO)

        atualizarStatus()
      }

      let historicoFome = [];
      let historicoSede = [];

    function cadastrarStatus() {
        var idGato = sessionStorage.ID_GATO;

        if (sessionStorage.EMAIL_USUARIO && sessionStorage.NOME_USUARIO) {
            var fomeVar = fome;
            var sedeVar = sede;

            fetch("/gatoStatus/cadastrar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    fomeGatoServer: fomeVar,
                    sedeGatoServer: sedeVar,
                    gatoIdServer: idGato,
                    donoIdServer: sessionStorage.ID_USUARIO,
                }),
            })
            .then(function (resposta) {
                if (resposta.ok) {
                    console.log(resposta);
                } else {
                    throw "Erro ao cadastrar o status!";
                }
            })
            .catch(function (erro) {
                console.log(`#ERRO: ${erro}`);
            });

            return false;
        } else {
            return false;
        }
    }

      async function autenticarStatus() {
        try {
          if (!sessionStorage.ID_GATO || !sessionStorage.ID_USUARIO) {
            throw new Error("ID do gato ou usuário ausente!");
          }

          const resposta = await fetch("/gatoStatus/autenticar", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
            body: JSON.stringify({
              gatoIdServer: sessionStorage.ID_GATO,
              donoIdServer: sessionStorage.ID_USUARIO,
            }),
          });

          if (!resposta.ok) {
            throw new Error("Erro ao autenticar o status do gato!");
          }

          const json = await resposta.json();

          console.log("Dados autenticados:", json);

          sessionStorage.FOME_GATO = json.fome;
          sessionStorage.SEDE_GATO = json.sede;
          sessionStorage.DT_HORA = json.dtHora;
          sessionStorage.STATUS_VIDA = json.status_vida;

          historicoFome.push(json.fome);
          historicoSede.push(json.sede);

          atualizarStatus();
        } catch (erro) {
          console.log(`Erro ao autenticar o status: ${erro.message}`);
        }
      }


      var notificacoes = 0;

      function atualizarStatus() {
          cadastrarStatus();
         if (sessionStorage.STATUS_VIDA == 'VIVO') {
          cadastrarStatus();
          // Verifica a fome e a sede do gato e atualiza o status
          if (fome > 0) fome -= 1;
          if (sede > 0) sede -= 1;
  
          // Atualiza as barras de fome e sede na tela
          fome_gato.style.width = Math.max(fome, 0) + "%";
          sede_gato.style.width = Math.max(sede, 0) + "%";
  
          // Armazena o status no sessionStorage
          sessionStorage.FOME_GATO = fome;
          sessionStorage.SEDE_GATO = sede;

          indicador_fome.innerHTML = sessionStorage.FOME_GATO;
          indicador_sede.innerHTML = sessionStorage.SEDE_GATO;

          notificacoes++;

          if (notificacoes > 0) {
            notificacao.style.display = "flex";
            notificacao.innerHTML = notificacoes;
          }
        }
        

          if (fome == 0 || sede == 0 || sessionStorage.STATUS_VIDA == "MORTO") { 
          clearInterval(intervaloStatus);         
          deletar();
          mostrarSelecao();
          cadastrarStatus();
          div_gato.style.display = "none";
        }

        if (sessionStorage.STATUS_VIDA == 'MORTO') {
          fome = 0;
          sede = 0;
        }
      }

      function deletar() {
        fetch("/gatoStatus/deletar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            donoIdServer: sessionStorage.ID_USUARIO,
          }),
        })
          .then(function (resposta) {

            sessionStorage.STATUS_VIDA = 'MORTO';

            if (resposta.ok) {
              console.log(resposta);
            } else {
              throw "Houve um erro ao tentar 'deletar'!";
            }
          })
          .catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
          });
      }

      function mostrarDashboard() {
        obterDadosGrafico(sessionStorage.ID_GATO); 
        dashboard.style.display = "flex";
        notificacoes = 0;
        notificacao.style.display = "none";
      }

      function fecharDashboard() {
        dashboard.style.display = "none";
      }

      let proximaAtualizacao;

      var idGato = sessionStorage.ID_GATO;

      function obterDadosGrafico(idGato) {

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medida/tempo-real/${idGato}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGrafico(resposta, idGato);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
        }

        function plotarGrafico(resposta, idGato) {

          console.log(resposta);

          console.log('iniciando plotagem do gráfico...');

          // Criando estrutura para plotar gráfico - labels
          let labels = [];

          // Criando estrutura para plotar gráfico - dados
          let dados = {
          labels: [],
          datasets: [
          {
              label: 'Fome',
              data: [],
              fill: false,
              borderColor: '#ffb3c1',
              tension: 0.1
          },
          {
              label: 'Sede',
              data: [],
              fill: false,
              borderColor: '#ffb3c1',
              fontSize: 10,
              color: '#ffb3c1',
              tension: 0.1
          },
          ]
          };


          console.log('----------------------------------------------')
          console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
          console.log(resposta)

          // Inserindo valores recebidos em estrutura para plotar o gráfico
          for (i = 0; i < resposta.length; i++) {
              var registro = resposta[i];
              var dataHora = registro['Data e Hora'];

              var dataConvertida = new Date(dataHora);

              if (isNaN(dataConvertida)) {
                console.error(`Data inválida: ${dataHora}`);
              } else {
                labels.push(dataConvertida);
                dados.labels.push(dataConvertida);
                dados.datasets[0].data.push(registro.Fome);
                dados.datasets[1].data.push(registro.Sede);
              }
          }

          console.log('----------------------------------------------')
          console.log('O gráfico será plotado com os respectivos valores:')
          console.log('Labels:')
          console.log(labels)
          console.log('Dados:')
          console.log(dados.datasets)
          console.log('----------------------------------------------')

          // Criando estrutura para plotar gráfico - config
          if (dados.labels.length > 0) {
            const config = {
                type: 'bar',  // Alterado de 'line' para 'bar'
                data: dados,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    elements: {
                        bar: {
                          borderWidth: 2, // Espessura da borda das barras
                          borderRadius: 10, // Raio das bordas das barras
                          borderColor: '#ffb3c1', // Cor da borda das barras
                          backgroundColor: '#ffb3c1', // Cor de preenchimento das barras (translúcido)
                          shadowColor: '#ffb3c1', // Cor da sombra
                          shadowBlur: 10, // Difusão da sombra
                          shadowOffsetX: 4, // Deslocamento da sombra no eixo X
                          shadowOffsetY: 4, // Deslocamento da sombra no eixo Y
                        },
                    },
                    plugins: {
                        tooltip: {
                            bodyColor: '#fff', // Cor do texto do corpo do tooltip
                            titleColor: '#ffb3c1', // Cor do título do tooltip
                            bodyFont: {
                                family: 'VCR', // Fonte personalizada para o corpo do tooltip
                            },
                            titleFont: {
                                family: 'VCR', // Fonte personalizada para o título do tooltip
                            },
                        },
                        legend: {
                            labels: {
                                color: '#f495a9', // Cor do texto da legenda
                                font: {
                                    family: 'VCR',
                                    size: 20, // Fonte personalizada para legenda
                                },
                            },
                        },
                    },
                    scales: {
                        x: {
                            type: 'time', // Eixo X como tempo
                            time: {
                                unit: 'minute', // Unidade de tempo (ajuste conforme necessário)
                                tooltipFormat: 'yyyy-MM-dd HH:mm:ss', // Formato do tooltip
                            },
                            ticks: {
                                color: 'rgb(255, 99, 132)', // Cor do texto no eixo X
                                font: {
                                    family: 'VCR', // Fonte personalizada para os ticks do eixo X
                                },
                            },
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Valor',
                                color: '#f495a9', // Cor do título do eixo Y
                                font: {
                                    size: 25, // Tamanho da fonte do título
                                    family: 'VCR', // Fonte personalizada para o título do eixo Y
                                },
                            },
                            ticks: {
                                color: '#f495a9', // Cor do texto no eixo Y
                                font: {
                                    size: 15,
                                    family: 'VCR', // Fonte personalizada para os ticks do eixo Y
                                },
                            },
                        },
                    },
                },
            };

            // Criar o gráfico
            let myChart = new Chart(
                document.getElementById(`myChartCanvas`),
                config
            );

            // Iniciar o loop de atualização
            setTimeout(() => atualizarGrafico(idGato, dados, myChart), 2000);
        } else {
            console.error("Não há dados para preencher o gráfico.");
        }
    }

          function atualizarGrafico(idGato, dados, myChart) {
            fetch(`/medida/tempo-real/${idGato}`, { cache: 'no-store' }).then(function (response) {
                if (response.ok) {
                    response.json().then(function (novoRegistro) {
                        console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                        console.log(`Dados atuais do gráfico:`);
                        console.log(dados);

                        // Verifique se há dados no gráfico antes de fazer qualquer comparação
                        if (dados.labels.length > 0) {
                            const lastLabel = dados.labels[dados.labels.length - 1];
                            console.log('Última label:', lastLabel);

                            // Se o novo dado já estiver no gráfico, não faz sentido atualizar
                            if (novoRegistro[0]['Data e Hora'] == lastLabel) {
                                console.log("Não há dados novos para atualização.");
                            } else {
                                // Atualize os dados do gráfico
                                dados.labels.shift();  // Remove o primeiro
                                dados.labels.push(new Date(novoRegistro[0]['Data e Hora']));  // Adiciona o novo valor

                                dados.datasets[0].data.shift();  // Remove o primeiro de Fome
                                dados.datasets[0].data.push(novoRegistro[0].Fome);  // Adiciona a nova medida de Fome

                                dados.datasets[1].data.shift();  // Remove o primeiro de Sede
                                dados.datasets[1].data.push(novoRegistro[0].Sede);  // Adiciona a nova medida de Sede

                                myChart.update();
                            }
                        } else {
                            console.error("Não há dados para comparar.");
                        }

                        // Atualiza o gráfico periodicamente
                        proximaAtualizacao = setTimeout(() => atualizarGrafico(idGato, dados, myChart), 2000);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idGato, dados, myChart), 2000);
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
        }

        window.onload = function () {
          listar(); 
          verificarGato(); 
          cadastrarStatus(); 
          autenticarStatus(); 
        }
    </script>
  </body>
</html>
